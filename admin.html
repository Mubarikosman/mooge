<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Moge Campaign</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap');
        body { font-family: 'Manrope', sans-serif; background-color: #f1f5f9; }
        .stat-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
        .table-container {
             background-color: white;
             border-radius: 0.75rem;
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
             overflow: hidden;
        }
        table thead {
            background-color: #f8fafc;
        }
        .login-card {
             background: rgba(255, 255, 255, 0.2);
             border-radius: 16px;
             box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
             backdrop-filter: blur(5px);
             -webkit-backdrop-filter: blur(5px);
             border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .input-field {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #e2e8f0;
            color: #1e293b;
        }
        .input-field::placeholder {
            color: #94a3b8;
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-cover bg-center" style="background-image: url('https://source.unsplash.com/1600x900/?hargeisa,cityscape');">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="login-card p-8 w-full max-w-md text-white text-center">
            <h1 class="text-3xl font-bold mb-2">Admin Panel</h1>
            <p class="mb-6 opacity-80">Fadlan geli aqoonsigaaga si aad u gasho.</p>
            <div class="space-y-4 text-left">
                <div>
                    <label for="admin-id" class="font-semibold mb-1 block">Admin ID</label>
                    <input type="text" id="admin-id" placeholder="Geli ID-gaaga" class="input-field w-full rounded-lg px-4 py-2.5">
                </div>
                <div>
                    <label for="admin-password" class="font-semibold mb-1 block">Password</label>
                    <input type="password" id="admin-password" placeholder="Geli erayga sirta ah" class="input-field w-full rounded-lg px-4 py-2.5">
                </div>
                 <div>
                    <label for="admin-secret" class="font-semibold mb-1 block">Secret Word</label>
                    <input type="password" id="admin-secret" placeholder="Geli erayga qarsoon" class="input-field w-full rounded-lg px-4 py-2.5">
                </div>
            </div>
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg mt-6 transition-colors">Login</button>
            <p id="login-error" class="text-red-300 mt-4 text-sm font-semibold hidden">Aqoonsi khaldan. Fadlan isku day mar kale.</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800">Moge Campaign Dashboard</h1>
                <button id="logout-btn" class="text-sm font-semibold text-slate-600 hover:text-blue-600 flex items-center gap-2">
                    <span>Logout</span>
                    <i data-feather="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-slate-500">Wadarta Codadka</p>
                        <i data-feather="bar-chart-2" class="w-6 h-6 text-blue-500"></i>
                    </div>
                    <p id="total-votes" class="text-4xl font-extrabold text-slate-800 mt-2">0</p>
                </div>
                <div class="stat-card">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-slate-500">Magaalooyinka Codeeyay</p>
                        <i data-feather="map" class="w-6 h-6 text-green-500"></i>
                    </div>
                    <p id="unique-cities" class="text-4xl font-extrabold text-slate-800 mt-2">0</p>
                </div>
                <div class="stat-card">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-slate-500">Dalalka Codeeyay</p>
                        <i data-feather="globe" class="w-6 h-6 text-purple-500"></i>
                    </div>
                    <p id="unique-countries" class="text-4xl font-extrabold text-slate-800 mt-2">0</p>
                </div>
                <div class="stat-card">
                     <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-slate-500">Farriimaha Cusub</p>
                        <i data-feather="inbox" class="w-6 h-6 text-red-500"></i>
                    </div>
                    <p id="total-messages" class="text-4xl font-extrabold text-slate-800 mt-2">0</p>
                </div>
            </div>

            <!-- Voters & Messages Tabs -->
            <div class="mb-8">
                <div class="border-b border-slate-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="voters-tab-btn" class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Codbixiyeyaasha</button>
                        <button id="messages-tab-btn" class="tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Farriimaha</button>
                    </nav>
                </div>
            </div>

            <!-- Voters Table -->
            <div id="voters-content" class="table-container">
                <div class="p-4 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-slate-700">Liiska Codbixiyeyaasha</h2>
                    <input id="search-voters" type="text" placeholder="Raadi magac, magaalo..." class="w-64 rounded-md border-slate-300 shadow-sm text-sm">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase">
                            <tr>
                                <th scope="col" class="px-6 py-3">Magaca</th>
                                <th scope="col" class="px-6 py-3">Magaalada</th>
                                <th scope="col" class="px-6 py-3">Dalka</th>
                                <th scope="col" class="px-6 py-3">Telefoon</th>
                                <th scope="col" class="px-6 py-3">Goorta</th>
                            </tr>
                        </thead>
                        <tbody id="voters-table-body">
                           <!-- JS will populate this -->
                           <tr><td colspan="5" class="text-center p-8">Sug, xogta waa la soo wadayaa...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Messages Table -->
            <div id="messages-content" class="table-container hidden">
                <div class="p-4">
                     <h2 class="text-lg font-semibold text-slate-700">Liiska Farriimaha</h2>
                </div>
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase">
                            <tr>
                                <th scope="col" class="px-6 py-3">Magaca</th>
                                <th scope="col" class="px-6 py-3">Email</th>
                                <th scope="col" class="px-6 py-3">Farriinta</th>
                                <th scope="col" class="px-6 py-3">Goorta</th>
                            </tr>
                        </thead>
                        <tbody id="messages-table-body">
                           <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();

            // --- FIREBASE CONFIG ---
             const firebaseConfig = {
                apiKey: "AIzaSyAnsvGANXpSJVq6B2Yd4woI4caflDvzrYI",
                authDomain: "maayor-mooge.firebaseapp.com",
                projectId: "maayor-mooge",
                storageBucket: "maayor-mooge.appspot.com",
                messagingSenderId: "771226998257",
                appId: "1:771226998257:web:d8029353f27111f143e050"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // --- ELEMENTS ---
            const loginScreen = document.getElementById('login-screen');
            const dashboard = document.getElementById('dashboard');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const loginError = document.getElementById('login-error');
            
            // --- AUTHENTICATION & STATE LOGIC ---
            const ADMIN_ID = "20202030";
            const ADMIN_PASS = "mooge admin 2030";
            const ADMIN_SECRET = "ma ogi";

            function showDashboard() {
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                feather.replace();
                initializeRealtimeListeners(); // Start listening for data
            }

            function showLogin() {
                dashboard.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                sessionStorage.removeItem('adminLoggedIn');
            }

            loginBtn.addEventListener('click', () => {
                const id = document.getElementById('admin-id').value;
                const pass = document.getElementById('admin-password').value;
                const secret = document.getElementById('admin-secret').value;

                if (id === ADMIN_ID && pass === ADMIN_PASS && secret === ADMIN_SECRET) {
                    sessionStorage.setItem('adminLoggedIn', 'true'); // Store login state
                    showDashboard();
                } else {
                    loginError.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', showLogin);

            // Check session storage on page load
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showDashboard();
            }

            // --- REAL-TIME DATA LOGIC ---
            let allVoters = []; // Cache for searching

            function initializeRealtimeListeners() {
                // VOTERS LISTENER
                db.collection('votes').orderBy('votedAt', 'desc').onSnapshot(snapshot => {
                    allVoters = [];
                    const citySet = new Set();
                    const countrySet = new Set();
                    
                    const votersTableBody = document.getElementById('voters-table-body');
                    votersTableBody.innerHTML = ''; // Clear table
                    
                    snapshot.forEach(doc => {
                        const voter = doc.data();
                        allVoters.push(voter);

                        if (voter.city) citySet.add(voter.city.trim().toLowerCase());
                        if (voter.country) countrySet.add(voter.country.trim().toLowerCase());

                        const row = `
                            <tr class="bg-white border-b hover:bg-slate-50">
                                <td class="px-6 py-4 font-semibold text-slate-900">${voter.name || 'N/A'}</td>
                                <td class="px-6 py-4">${voter.city || 'N/A'}</td>
                                <td class="px-6 py-4">${voter.country || 'N/A'}</td>
                                <td class="px-6 py-4">${voter.phone || 'N/A'}</td>
                                <td class="px-6 py-4">${voter.votedAt ? new Date(voter.votedAt.seconds * 1000).toLocaleString() : 'N/A'}</td>
                            </tr>
                        `;
                        votersTableBody.innerHTML += row;
                    });
                    
                    if(snapshot.empty) {
                        votersTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8">Wali wax codbixiyeyaal ah ma jiraan.</td></tr>';
                    }

                    // Update stats
                    document.getElementById('total-votes').textContent = snapshot.size;
                    document.getElementById('unique-cities').textContent = citySet.size;
                    document.getElementById('unique-countries').textContent = countrySet.size;
                }, err => {
                    console.error("Error fetching votes: ", err);
                    document.getElementById('voters-table-body').innerHTML = '<tr><td colspan="5" class="text-center p-8 text-red-500">Cilad baa dhacday.</td></tr>';
                });

                // MESSAGES LISTENER
                db.collection('messages').orderBy('sentAt', 'desc').onSnapshot(snapshot => {
                    const messagesTableBody = document.getElementById('messages-table-body');
                    messagesTableBody.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const row = `
                            <tr class="bg-white border-b hover:bg-slate-50">
                                <td class="px-6 py-4 font-semibold text-slate-900">${msg.name || 'N/A'}</td>
                                <td class="px-6 py-4">${msg.email || 'N/A'}</td>
                                <td class="px-6 py-4"><p class="max-w-md truncate" title="${msg.message}">${msg.message || 'N/A'}</p></td>
                                <td class="px-6 py-4">${msg.sentAt ? new Date(msg.sentAt.seconds * 1000).toLocaleString() : 'N/A'}</td>
                            </tr>
                        `;
                         messagesTableBody.innerHTML += row;
                    });
                     if(snapshot.empty) {
                        messagesTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8">Wali wax farriimo ah ma jiraan.</td></tr>';
                    }
                    document.getElementById('total-messages').textContent = snapshot.size;

                }, err => {
                     console.error("Error fetching messages: ", err);
                     document.getElementById('messages-table-body').innerHTML = '<tr><td colspan="4" class="text-center p-8 text-red-500">Cilad baa dhacday.</td></tr>';
                });
            }

            // --- UI INTERACTIONS (TABS, SEARCH) ---
            const votersTabBtn = document.getElementById('voters-tab-btn');
            const messagesTabBtn = document.getElementById('messages-tab-btn');
            const votersContent = document.getElementById('voters-content');
            const messagesContent = document.getElementById('messages-content');

            votersTabBtn.addEventListener('click', () => {
                votersContent.classList.remove('hidden');
                messagesContent.classList.add('hidden');
                votersTabBtn.classList.add('border-blue-500', 'text-blue-600');
                messagesTabBtn.classList.remove('border-blue-500', 'text-blue-600');
            });
            messagesTabBtn.addEventListener('click', () => {
                messagesContent.classList.remove('hidden');
                votersContent.classList.add('hidden');
                messagesTabBtn.classList.add('border-blue-500', 'text-blue-600');
                votersTabBtn.classList.remove('border-blue-500', 'text-blue-600');
            });

            const searchInput = document.getElementById('search-voters');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredVoters = allVoters.filter(voter => 
                    voter.name?.toLowerCase().includes(searchTerm) ||
                    voter.city?.toLowerCase().includes(searchTerm) ||
                    voter.country?.toLowerCase().includes(searchTerm)
                );
                
                const votersTableBody = document.getElementById('voters-table-body');
                votersTableBody.innerHTML = '';
                 filteredVoters.forEach(voter => {
                    const row = `
                        <tr class="bg-white border-b hover:bg-slate-50">
                            <td class="px-6 py-4 font-semibold text-slate-900">${voter.name || 'N/A'}</td>
                            <td class="px-6 py-4">${voter.city || 'N/A'}</td>
                            <td class="px-6 py-4">${voter.country || 'N/A'}</td>
                            <td class="px-6 py-4">${voter.phone || 'N/A'}</td>
                            <td class="px-6 py-4">${voter.votedAt ? new Date(voter.votedAt.seconds * 1000).toLocaleString() : 'N/A'}</td>
                        </tr>
                    `;
                    votersTableBody.innerHTML += row;
                 });
            });
        });
    </script>
</body>
</html>

